version: "3"

services:

  mysql:
    image: mysql:8.0
    container_name: mysql
    platform: linux/amd64
    environment:
      MYSQL_ROOT_PASSWORD: ${LOCAL_DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${LOCAL_DB_NAME}
      MYSQL_USER: ${LOCAL_DB_USER}
      MYSQL_PASSWORD: ${LOCAL_DB_PASSWORD}
    volumes:
      - dbdata:/var/lib/mysql
      - "./mysql/init-db.sql:/init-db.sql"
    ports:
      - "3306:3306"
    restart: unless-stopped
    networks:
      - app-network
    command: --sql-mode=""
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${LOCAL_DB_ROOT_PASSWORD}"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s

  nginx:
    image: nginx:stable-alpine
    platform: linux/amd64
    container_name: nginx
    volumes:
      - "./src/www/cantine/server/node:/var/www/html/"
      - "./src/www/cantine/client/old:/var/www/client/old"
      - "./src/www/cantine/client/acdlp-angular/dist/browser:/var/www/client/angular/dist/browser"
      - "./nginx/nginx.dev.conf:/etc/nginx/conf.d/default.conf"
      - "./nginx/maintenance:/var/www/maintenance"
    ports:
      - "80:80"
    depends_on:
      - node
      #- angular
    networks:
      - app-network

  node:
    platform: linux/amd64
    image: node:22
    container_name: node
    working_dir: /usr/src/app
    volumes:
      - "./src/www/cantine/server/node:/usr/src/app"
      - "./.env:/usr/src/app/.env"
      - "./src/www/cantine/server/node/pdf/recuFiscal:/usr/src/app/pdf/recuFiscal"
      - "./src/www/cantine/client/acdlp-angular/src/assets:/usr/src/app/assets"
      - "logs-data:/var/log/cantine"
      - "node_modules:/usr/src/app/node_modules"
    ports:
      - "4242:4242"
    command: ["sh", "-c", "npm install && npm start"]
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - app-network
    stdin_open: true
    tty: true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4242/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  angular:
    platform: linux/amd64
    image: node:22
    container_name: angular
    working_dir: /usr/src/app/src/www/cantine/client/acdlp-angular
    environment:
      NG_CLI_ANALYTICS: "false"
      NPM_CONFIG_LEGACY_PEER_DEPS: "true"
    ports:
      - "4200:4200"
    volumes:
      - ./src/www/cantine/client/acdlp-angular:/usr/src/app/src/www/cantine/client/acdlp-angular
      - ./src/www/cantine/client/acdlp-angular/dist:/usr/src/app/src/www/cantine/client/acdlp-angular/dist
      - angular_node_modules:/usr/src/app/src/www/cantine/client/acdlp-angular/node_modules
    command: >
      bash -c "
        if [ ! -f 'package.json' ]; then \
            npm install -g @angular/cli@latest && \
            npx -y @angular/cli@latest new my-app --routing --style=scss --defaults --skip-git && \
            mv my-app/* . && mv my-app/.* . 2>/dev/null || true && rmdir my-app; \
        fi && \
        npm install --legacy-peer-deps && \
        npx ng serve --host 0.0.0.0 --poll 2000"
    networks:
      - app-network
    stdin_open: true
    tty: true


  phpmyadmin:
    platform: linux/amd64
    image: phpmyadmin/phpmyadmin
    container_name: phpmyadmin
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      UPLOAD_LIMIT: 10000000000
    ports:
      - "8080:80"
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - app-network

  loki:
    platform: linux/amd64
    image: grafana/loki:2.9.0
    container_name: loki
    ports:
      - "3100:3100"
    volumes:
      - "./loki/config.yml:/etc/loki/config.yml"
      - "loki-data:/loki"
    command: -config.file=/etc/loki/config.yml
    restart: unless-stopped
    networks:
      - app-network

  promtail:
    platform: linux/amd64
    image: grafana/promtail:2.9.0
    container_name: promtail
    volumes:
      - "./promtail/config.yml:/etc/promtail/config.yml"
      - "logs-data:/var/log/cantine:ro"
    command: -config.file=/etc/promtail/config.yml
    restart: unless-stopped
    depends_on:
      - loki
    networks:
      - app-network

  grafana:
    platform: linux/amd64
    image: grafana/grafana:10.2.0
    container_name: grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SERVER_ROOT_URL=http://localhost/grafana
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_USERS_AUTO_ASSIGN_ORG_ROLE=Admin
      - GF_AUTH_GITHUB_ENABLED=true
      - GF_AUTH_GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GF_AUTH_GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      - GF_AUTH_GITHUB_ALLOW_SIGN_UP=true
      - GF_AUTH_GITHUB_AUTO_LOGIN=false
      - GF_AUTH_DISABLE_LOGIN_FORM=false
    volumes:
      - "grafana-data:/var/lib/grafana"
      - "./grafana/provisioning:/etc/grafana/provisioning"
    restart: unless-stopped
    depends_on:
      - loki
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  dbdata:
  logs-data:
  loki-data:
  grafana-data:

  node_modules:
  angular_node_modules: