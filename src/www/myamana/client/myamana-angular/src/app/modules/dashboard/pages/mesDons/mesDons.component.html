<div>
  <!-- Header -->
  <h1 class="text-2xl font-bold mb-6">Mes dons</h1>
  <!-- end Header -->

  <!-- État de chargement -->
  <div *ngIf="isLoading" class="bg-background rounded-lg p-8 text-center">
    <div class="flex flex-col items-center justify-center gap-4">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
      <p class="text-muted-foreground">Chargement de vos dons en cours...</p>
    </div>
  </div>

  <!-- État d'erreur -->
  <div *ngIf="!isLoading && loadError" class="bg-background rounded-lg p-6 text-center">
    <div class="flex flex-col items-center justify-center gap-4">
      <div class="text-red-500 text-2xl">⚠️</div>
      <p class="text-muted-foreground">Nous n'avons trouvé aucun dons vous concernant. En cas de doute, n'hésitez pas à vous rapprocher des vos associations.</p>
      <button (click)="loadDons()" class="mt-4 px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors">
        Réessayer
      </button>
    </div>
  </div>

  <!-- État de succès -->
  <div *ngIf="!isLoading && !loadError" class="grid grid-cols-1 gap-4">
    <!-- Cartes horizontales des dons ponctuels -->
    <div *ngFor="let don of donsPonctuels" class="bg-background rounded-lg shadow-sm p-4 hover:bg-card transition-colors duration-200">
      <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
        <!-- Image de l'association -->
        <div class="flex-shrink-0 w-16 h-16 rounded-md overflow-hidden">
          <img [src]="don.image" (error)="handleImageError($event)" class="w-full h-full object-cover" [alt]="don.asso" />
        </div>
        
        <!-- Informations principales -->
        <div class="flex-grow">
          <h3 class="text-md font-semibold text-foreground">{{ don.asso }}</h3>
          <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-4 mt-1 text-sm text-muted-foreground">
            <span>Don effectué le {{ don.date }}</span>
          </div>
        </div>
        
        <!-- Montant et moyen de paiement regroupés dans un même conteneur -->
        <div class="flex flex-row items-center gap-2">
          <!-- Montant -->
          <div class="flex-shrink-0">
            <span class="text-lg font-bold text-foreground">{{ don.montant }} €</span>
          </div>
          
          <!-- Moyen de paiement -->
          <div class="flex-shrink-0 flex items-center gap-1">
            <!-- Visa -->
            <fa-icon *ngIf="don.moyen === 'CB' && don.brand === 'visa'" 
                    [icon]="faVisa" 
                    class="text-[#1434CB] text-xl"
                    title="Visa">
            </fa-icon>

            <!-- Mastercard -->
            <svg *ngIf="don.moyen === 'CB' && don.brand === 'mastercard'" 
                class="h-5 inline-block" 
                viewBox="0 0 48 32" 
                fill="none" 
                xmlns="http://www.w3.org/2000/svg"
                title="Mastercard">
              <circle cx="16" cy="16" r="12" fill="#EB001B"/>
              <circle cx="32" cy="16" r="12" fill="#F79E1B" style="mix-blend-mode: multiply"/>
            </svg>

            <!-- American Express -->
            <fa-icon *ngIf="don.moyen === 'CB' && don.brand === 'american-express'" 
                    [icon]="faAmex" 
                    class="text-[#006FCF] text-xl"
                    title="American Express">
            </fa-icon>

            <!-- Carte Bancaire (CB) générique -->
            <fa-icon *ngIf="don.moyen === 'CB' && (!don.brand || don.brand === 'carte-bancaire')" 
                    [icon]="faCard" 
                    class="text-indigo-600 text-xl"
                    title="Carte Bancaire">
            </fa-icon>
            
            <!-- IBAN -->
            <fa-icon *ngIf="don.moyen === 'IBAN'" 
                    [icon]="faIban" 
                    class="text-blue-600 text-xl"
                    title="Prélèvement SEPA">
            </fa-icon>
            
            <!-- PayPal -->
            <fa-icon *ngIf="don.moyen === 'paypal'" 
                    [icon]="faPaypal" 
                    class="text-[#003087] text-xl"
                    title="PayPal">
            </fa-icon>
            
            <!-- Virement -->
            <fa-icon *ngIf="don.moyen === 'Virement'" 
                    [icon]="faTransfer" 
                    class="text-blue-600 text-xl"
                    title="Virement bancaire">
            </fa-icon>
            
            <!-- Chèque -->
            <fa-icon *ngIf="don.moyen === 'Chèque'" 
                    [icon]="faCheck" 
                    class="text-amber-600 text-xl"
                    title="Chèque">
            </fa-icon>
            
            <!-- Espèces -->
            <fa-icon *ngIf="don.moyen === 'Espèces'" 
                    [icon]="faCash" 
                    class="text-emerald-600 text-xl"
                    title="Espèces">
            </fa-icon>
            
            <!-- Fallback pour les autres moyens de paiement -->
            <span *ngIf="!['CB', 'IBAN', 'paypal', 'Virement', 'Chèque', 'Espèces'].includes(don.moyen)" class="text-xs">{{don.moyen || 'N/A'}}</span>
            
            <!-- Numéro de carte masqué si disponible -->
            <span *ngIf="don.last4" class="text-xs ml-1">•••• {{ don.last4 }}</span>
          </div>
        </div>
      </div>
      
      <!-- Informations supplémentaires (extensibles) -->
      <div class="mt-3 pt-3 border-t border-border text-sm text-muted-foreground">
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2">
          <!-- Informations sur le don -->
          <div *ngIf="don.id" class="flex items-center gap-1">
            <span class="font-medium">ID:</span>
            <span>{{ don.id }}</span>
          </div>
          
          <div *ngIf="don.type" class="flex items-center gap-1">
            <span class="font-medium">Type:</span>
            <span>{{ don.type }}</span>
          </div>
          
          <!-- Section reçu fiscal -->
          <div class="flex flex-col gap-1 col-span-1 sm:col-span-2 md:col-span-3 mt-2">
            <div class="flex items-center gap-1">
              <span class="font-medium">Reçu fiscal:</span>
              
              <!-- Cas où les informations de l'association sont en cours de chargement -->
              <span *ngIf="!assoInfos[don.assoUri]" class="text-gray-500">
                Chargement des informations...
              </span>
              
              <!-- Cas 1: L'association ne délivre pas de reçu fiscal (prioritaire) -->
              <span *ngIf="assoInfos[don.assoUri] && !assoDeliversReceipt(don.assoUri)" class="text-gray-500 italic">
                L'association ne délivre pas de reçu fiscal.
              </span>
              
              <!-- Cas 2: L'association délivre des reçus fiscaux mais le reçu fiscal n'a pas été généré -->
              <button *ngIf="assoInfos[don.assoUri] && assoDeliversReceipt(don.assoUri) && !don.link"
                      (click)="!shouldDisableReceiptButton(don) && !generatingReceiptFor[don.id] && generateReceipt(don)"
                      [disabled]="shouldDisableReceiptButton(don) || generatingReceiptFor[don.id]"
                      [class.opacity-50]="shouldDisableReceiptButton(don) || generatingReceiptFor[don.id]"
                      [class.cursor-not-allowed]="shouldDisableReceiptButton(don) || generatingReceiptFor[don.id]"
                      [ngClass]="!shouldDisableReceiptButton(don) && !generatingReceiptFor[don.id] ? 'hover:bg-primary/90' : ''"
                      class="inline-flex items-center gap-1 px-3 py-1 rounded-md bg-primary text-primary-foreground text-xs font-medium transition-colors">
                <span *ngIf="!generatingReceiptFor[don.id]">
                  <fa-icon [icon]="faFileInvoice" class="text-sm"></fa-icon>
                  <span>Générer le reçu fiscal</span>
                </span>
                <span *ngIf="generatingReceiptFor[don.id]" class="flex items-center gap-1">
                  <svg class="animate-spin -ml-1 mr-1 h-3 w-3 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  <span>Génération en cours...</span>
                </span>
              </button>
              
              <!-- Cas 3: L'association délivre des reçus fiscaux et le reçu fiscal est disponible -->
              <button *ngIf="assoInfos[don.assoUri] && assoDeliversReceipt(don.assoUri) && don.link" 
                     (click)="!shouldDisableReceiptButton(don) && openReceipt(don)"
                     [disabled]="shouldDisableReceiptButton(don)"
                     [class.opacity-50]="shouldDisableReceiptButton(don)"
                     [class.cursor-not-allowed]="shouldDisableReceiptButton(don)"
                     [ngClass]="!shouldDisableReceiptButton(don) ? 'hover:bg-primary/90' : ''"
                     class="inline-flex items-center gap-1 px-3 py-1 rounded-md bg-primary text-primary-foreground text-xs font-medium transition-colors">
                <fa-icon [icon]="faFileDownload" class="text-sm"></fa-icon>
                <span>Télécharger le reçu fiscal</span>
              </button>
            </div>
            
            <!-- Message explicatif pour les dons par Chèque ou Virement -->
            <span *ngIf="assoInfos[don.assoUri] && assoDeliversReceipt(don.assoUri) && shouldDisableReceiptButton(don)" 
                  class="text-xs text-amber-600 italic ml-0">
              {{ getDisabledReceiptMessage() }}
            </span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Message si aucun don -->
    <div *ngIf="donsPonctuels.length === 0" class="bg-background rounded-lg p-6 text-center">
      <p class="text-muted-foreground">Vous n'avez pas encore effectué de dons.</p>
    </div>
  </div>
  
  <!-- Dialogue de mise à jour d'adresse -->
  <app-address-update-dialog 
    *ngIf="showAddressDialog"
    [title]="'Mise à jour des informations d\'adresse'"
    [initialData]="{ adresse: currentDon?.adresse || '', ville: currentDon?.ville || '', codePostal: currentDon?.codePostal || '' }"
    (onConfirm)="onAddressConfirm($event)"
    (onCancel)="onAddressCancel()">
  </app-address-update-dialog>
</div>
