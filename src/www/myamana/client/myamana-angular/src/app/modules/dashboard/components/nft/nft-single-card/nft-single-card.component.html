<div class="flex h-[420px] flex-col rounded-lg bg-background p-8 relative"
  [ngClass]="{ 'opacity-50': nft.statut === 'pending' }">
  <!-- Message d'erreur ou d'information -->
  <div *ngIf="(nft.statut === 'failed' && nft.error_mail_sent) || nft.statut === 'pause'"
       class="absolute top-0 left-0 right-0 px-2 sm:px-4 py-1 sm:py-2 text-xs font-medium rounded-t-lg border-b overflow-hidden"
       [ngClass]="{
         'bg-red-100 text-red-800 border-red-200': nft.statut === 'failed',
         'bg-orange-100 text-orange-800 border-orange-200': nft.statut === 'pause'
       }">
       <ng-container *ngIf="nft.statut === 'failed'">
         <div class="line-clamp-2">
           ⚠️ Votre don a échoué pour la raison suivante ⚠️ : {{ nft.error_mail_sent }} Cliquez sur modifier pour reprendre votre don.
         </div>
       </ng-container>
       <ng-container *ngIf="nft.statut === 'pause'">
         <div class="flex flex-wrap items-center gap-1">
           <span>ℹ️ Don suspendu - Reprise prévue le {{ nft.resumeDate }}</span>
         </div>
       </ng-container>
  </div>

  <!-- Indicateur de statut (seulement si actif ou en attente) -->
  <div *ngIf="nft.statut !== 'failed' && nft.statut !== 'pause'" class="absolute top-2 right-2">
    <span class="px-2 py-1 rounded-full text-xs font-medium"
          [ngClass]="{
            'bg-green-100 text-green-800': nft.statut === 'actif',
            'bg-yellow-100 text-yellow-800': nft.statut === 'pending'
          }">
      {{ nft.statut === 'actif' ? 'Actif' : 'En attente' }}
    </span>
  </div>
  <div class="h-[240px] flex justify-center items-center overflow-hidden rounded-md">
    <img [src]="nft.image" alt="{{ nft.asso }}" class="max-h-full max-w-full object-contain" />
  </div>

  <h2 class="text-md mt-6 font-semibold text-foreground truncate">{{ nft.asso }}</h2>
  <div class="flex flex-col gap-2 text-sm font-semibold text-muted-foreground">
    <div class="flex items-end justify-between">
      <span class="whitespace-nowrap">{{ nft.montant }} € / {{nft.occurence}} </span>
    </div>
    <div class="flex items-center gap-1">
      <!-- IBAN -->
      <fa-icon *ngIf="nft.moyen === 'IBAN'" 
               [icon]="faIban" 
               class="text-blue-600 text-xl">
      </fa-icon>

      <!-- Visa -->
      <fa-icon *ngIf="nft.moyen === 'CB' && nft.brand === 'visa'" 
               [icon]="faVisa" 
               class="text-[#1434CB] text-2xl">
      </fa-icon>

      <!-- Mastercard -->
      <svg *ngIf="nft.moyen === 'CB' && nft.brand === 'mastercard'" 
           class="h-6" 
           viewBox="0 0 48 32" 
           fill="none" 
           xmlns="http://www.w3.org/2000/svg">
        <circle cx="16" cy="16" r="12" fill="#EB001B"/>
        <circle cx="32" cy="16" r="12" fill="#F79E1B" style="mix-blend-mode: multiply"/>
      </svg>

      <!-- American Express -->
      <fa-icon *ngIf="nft.moyen === 'CB' && nft.brand === 'american-express'" 
               [icon]="faAmex" 
               class="text-[#006FCF] text-2xl">
      </fa-icon>

      <!-- Carte Bancaire (CB) générique -->
      <fa-icon *ngIf="nft.moyen === 'CB' && (!nft.brand || nft.brand === 'carte-bancaire')" 
               [icon]="faCard" 
               class="text-indigo-600 text-xl">
      </fa-icon>

      <span class="text-xs ml-1">•••• {{ nft.last4 }}</span>
    </div>
  </div>

  <div class="mt-4 flex flex-wrap gap-2">
    <ng-container *ngIf="nft.statut === 'pending' || nft.statut === 'pause'; else activeButton">
      <span *ngIf="nft.statut === 'pending'" class="flex-none rounded-md bg-gray-400 px-2 sm:px-3 py-1.5 sm:py-2 text-xs font-semibold text-gray-700 whitespace-nowrap overflow-hidden text-ellipsis max-w-full">
        Prévu le {{ nft.recurrence }}
      </span>
      <button *ngIf="nft.statut === 'pause'" (click)="modifyResumeDate()"
        class="hover:bg-yellow-600 flex-none rounded-md bg-yellow-500 px-2 sm:px-3 py-1.5 sm:py-2 text-xs font-semibold text-white whitespace-nowrap">
        Modifier la reprise
      </button>
    </ng-container>  
    <ng-template #activeButton>
      <button (click)="modifySubscription()"
        class="hover:bg-primary-600 flex-none rounded-md bg-primary px-2 sm:px-3 py-1.5 sm:py-2 text-xs font-semibold text-primary-foreground whitespace-nowrap">
        Modifier
      </button>
      <button (click)="pauseSubscription(nft.stripeSubId, nft.uri)"
        class="hover:bg-yellow-600 flex-none rounded-md bg-yellow-500 px-2 sm:px-3 py-1.5 sm:py-2 text-xs font-semibold text-white whitespace-nowrap">
        Suspendre
      </button>
      <button (click)="cancelSubscription(nft.stripeSubId, nft.uri)"
        class="hover:bg-red-600 flex-none rounded-md bg-red-500 px-2 sm:px-3 py-1.5 sm:py-2 text-xs font-semibold text-white whitespace-nowrap">
        Annuler
      </button>
    </ng-template>
  </div>

  <!-- Stripe Subscription ID -->
  <div class="mt-auto pt-6 text-xs text-gray-400 border-t border-gray-200">
    ID: {{ nft.stripeSubId }}
  </div>

  <app-confirmation-dialog
    *ngIf="showDialog"
    [title]="'Confirmation'"
    [message]="'Êtes-vous sûr de vouloir annuler votre don récurrent ?'"
    [resultMessage]="resultMessage"
    (onConfirm)="onConfirmCancel(nft.stripeSubId, nft.uri)"
    (onCancel)="onCancelDialog()"
    (onClose)="onCloseDialog()"
  ></app-confirmation-dialog>

  <app-pause-dialog
    *ngIf="showPauseDialog"
    #pauseDialog
    [title]="'Suspension du don'"
    [message]="'Veuillez sélectionner la date à laquelle vous souhaitez reprendre votre don :'"
    [showMaxDateWarning]="true"
    [useMaxDateLimit]="false"
    (onConfirm)="onConfirmPause($event)"
    (onCancel)="onCancelPauseDialog()"
  ></app-pause-dialog>

  <app-modify-subscription-dialog
    *ngIf="showModifyDialog"
    [currentAmount]="nft.montant || 0"
    [asso]="nft.uri"
    [nft]="{
      email: nft.email,
      firstName: nft.firstName,
      lastName: nft.lastName,
      occurence: nft.occurence,
      recurrence: nft.recurrence,
      moyen: nft.moyen,
      last4: nft.last4,
      brand: nft.brand,
      expirationCB: nft.expirationCB
    }"
    (onConfirm)="onConfirmModify($event)"
    (onClose)="onCancelModify()"
  ></app-modify-subscription-dialog>

  <app-pause-dialog
    *ngIf="showModifyResumeDialog"
    #modifyResumeDialog
    [title]="'Modification de la date de reprise'"
    [message]="'Veuillez sélectionner la nouvelle date à laquelle vous souhaitez reprendre votre don :'"
    [showMaxDateWarning]="true"
    [useMaxDateLimit]="false"
    (onConfirm)="onConfirmModifyResume($event)"
    (onCancel)="onCancelModifyResumeDialog()"
  ></app-pause-dialog>
</div>
