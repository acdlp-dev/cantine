<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="bg-white shadow-sm rounded-lg p-6">
    <h2 class="text-2xl font-bold text-gray-900 mb-6">Générer une Carte Repas</h2>

    <!-- Message de succès -->
    <div *ngIf="successMessage" class="mb-4 p-4 bg-green-100 text-green-800 rounded-lg border border-green-200">
      {{ successMessage }}
    </div>

    <!-- Message d'erreur -->
    <div *ngIf="errorMessage" class="mb-4 p-4 bg-red-100 text-red-800 rounded-lg border border-red-200">
      {{ errorMessage }}
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <!-- Formulaire de génération -->
      <div>
        <h3 class="text-lg font-medium text-gray-700 mb-4">Informations du bénéficiaire</h3>

        <form (ngSubmit)="generateQRCode()" class="space-y-4">
          <div>
            <label for="nom" class="block text-sm font-medium text-gray-700 mb-1">Nom *</label>
            <input
              type="text"
              id="nom"
              name="nom"
              [(ngModel)]="beneficiaryForm.nom"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
              placeholder="Nom du bénéficiaire">
          </div>

          <div>
            <label for="prenom" class="block text-sm font-medium text-gray-700 mb-1">Prénom *</label>
            <input
              type="text"
              id="prenom"
              name="prenom"
              [(ngModel)]="beneficiaryForm.prenom"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
              placeholder="Prénom du bénéficiaire">
          </div>

          <div>
            <label for="nombre_beneficiaires" class="block text-sm font-medium text-gray-700 mb-1">Nombre de bénéficiaires *</label>
            <select
              id="nombre_beneficiaires"
              name="nombre_beneficiaires"
              [(ngModel)]="beneficiaryForm.nombre_beneficiaires"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
              <option *ngFor="let option of familySizeOptions" [value]="option">
                {{ option }} personne{{ option > 1 ? 's' : '' }}
              </option>
            </select>
          </div>

          <div class="pt-2">
            <button
              type="submit"
              [disabled]="isLoading"
              class="w-full bg-primary text-white py-2 px-4 rounded-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50 disabled:cursor-not-allowed">
              <span *ngIf="!isLoading">Générer QR Code</span>
              <span *ngIf="isLoading" class="flex items-center justify-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Génération en cours...
              </span>
            </button>
          </div>
        </form>
      </div>

      <!-- Résultat du QR code -->
      <div *ngIf="generatedQrCode">
        <h3 class="text-lg font-medium text-gray-700 mb-4">Carte Repas Générée</h3>

        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
          <div class="space-y-2 text-sm text-gray-800">
            <div class="flex justify-between">
              <span class="font-medium text-gray-600">ID Carte:</span>
              <span class="font-mono">{{ generatedQrCode.qr_code_id }}</span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-gray-600">Nom:</span>
              <span>{{ generatedQrCode.nom }} {{ generatedQrCode.prenom }}</span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-gray-600">Nombre de repas:</span>
              <span>{{ generatedQrCode.nombre_beneficiaires }}</span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-gray-600">Date de creation:</span>
              <span>{{ generatedQrCode.created_at | date:'short' }}</span>
            </div>
          </div>

          <div class="mt-4 bg-white rounded-lg border border-gray-200 p-3 text-xs text-gray-800">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="font-semibold text-gray-900">Carte Beneficiaire delivree le {{ generatedQrCode.created_at | date:'shortDate' }}</div>
                <div class="font-semibold text-gray-900">{{ generatedQrCode.association_nom || 'Au Coeur De La Precarite' }}</div>
                <div class="text-[11px] text-gray-600">Valable du {{ validityStart }} au {{ validityEnd }}</div>
              </div>
              <div class="bg-gray-50 rounded border border-gray-200 p-2 text-center">
                <div *ngIf="generatedQrCode?.qr_code_image; else noQrCode" class="qr-code-display">
                  <img [src]="generatedQrCode.qr_code_image" alt="QR Code Carte Repas"
                       class="mx-auto max-w-full h-auto" style="max-width: 120px;">
                </div>
                <ng-template #noQrCode>
                  <div class="text-gray-500 mb-1">
                    <svg class="w-10 h-10 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 1v1m-6 10v1m-6-2v1M4 12h1m10 0h1m-6-2h1m-6 2h1m10-2h1m-6 2h1m-6-2h1m10 2h1m-6-2h1m-6 2h1"></path>
                    </svg>
                  </div>
                  <p class="text-[10px] text-gray-600">QR Code</p>
                </ng-template>
              </div>
            </div>

            <div class="mt-2 grid grid-cols-2 gap-2 text-[11px]">
              <div><span class="font-semibold">Nom:</span> {{ generatedQrCode.nom }}</div>
              <div><span class="font-semibold">Prenom:</span> {{ generatedQrCode.prenom }}</div>
              <div><span class="font-semibold">Repas:</span> {{ generatedQrCode.nombre_beneficiaires }}</div>
              <div><span class="font-semibold">ID:</span> {{ generatedQrCode.qr_code_id }}</div>
            </div>

            <div class="mt-2 text-[11px] text-gray-700">
              <div class="font-semibold text-gray-900">Rappel des regles :</div>
              <div>- 1 Carte par famille</div>
              <div>- Enfants mineurs uniquement, sauf handicap (CMI)</div>
              <div>- Conjoints non pris en compte</div>
              <div>- Cartes expirees non valables</div>
            </div>

            <div class="mt-2 text-[11px] text-gray-700">
              <div class="font-semibold text-gray-900">Contact :</div>
              <div>{{ generatedQrCode.association_nom || 'Au Coeur De La Precarite' }} 62 avenue Jean Jaures 93450 ile saint denis</div>
            </div>

            <div class="mt-2 text-[11px] text-gray-700">
              Cette carte est unique - Editee par {{ generatedQrCode.association_nom || 'Au Coeur De La Precarite' }}
            </div>
          </div>

          <div *ngIf="generatedQrCode?.validation_url" class="mt-3 text-center">
            <p class="text-xs text-gray-500 mb-1">Lien de validation</p>
            <a [href]="generatedQrCode.validation_url"
               target="_blank"
               rel="noopener noreferrer"
               class="text-sm text-blue-600 hover:text-blue-700 break-all">
              {{ generatedQrCode.validation_url }}
            </a>
          </div>

          <div class="mt-4 flex space-x-2">
            <button
              (click)="downloadQRCode()"
              class="flex-1 bg-blue-600 text-white py-2 px-3 rounded-md text-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
              Télécharger
            </button>

            <button
              (click)="printQRCode()"
              class="flex-1 bg-green-600 text-white py-2 px-3 rounded-md text-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
              Imprimer
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Instructions -->
    <div class="mt-8 p-4 bg-blue-50 rounded-lg border border-blue-100">
      <h4 class="font-medium text-blue-800 mb-2">Instructions</h4>
      <ul class="text-sm text-blue-700 space-y-1">
        <li class="flex items-start">
          <span class="mr-2">•</span>
          <span>Remplissez les informations du bénéficiaire</span>
        </li>
        <li class="flex items-start">
          <span class="mr-2">•</span>
          <span>Cliquez sur "Générer QR Code"</span>
        </li>
        <li class="flex items-start">
          <span class="mr-2">•</span>
          <span>Téléchargez ou imprimez la carte pour le bénéficiaire</span>
        </li>
        <li class="flex items-start">
          <span class="mr-2">•</span>
          <span>Le bénéficiaire pourra utiliser cette carte pour récupérer ses repas</span>
        </li>
      </ul>
    </div>
  </div>
</div>
