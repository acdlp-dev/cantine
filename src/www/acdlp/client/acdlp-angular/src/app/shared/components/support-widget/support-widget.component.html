<!-- Bouton flottant -->
<button
  (click)="toggleWidget()"
  class="fixed bottom-6 right-6 z-50 flex h-14 w-14 items-center justify-center rounded-full bg-gradient-to-r from-emerald-500 to-teal-600 text-white shadow-lg transition-all duration-300 hover:scale-110 hover:shadow-xl"
  [class.rotate-45]="isOpen"
  aria-label="Support"
>
  <lucide-icon *ngIf="!isOpen" name="message-circle" [size]="24"></lucide-icon>
  <lucide-icon *ngIf="isOpen" name="x" [size]="24"></lucide-icon>
</button>

<!-- Modal Widget -->
<div
  *ngIf="isOpen"
  class="fixed bottom-24 right-6 z-50 w-96 max-w-[calc(100vw-2rem)] overflow-hidden rounded-2xl bg-white shadow-2xl animate-slideIn"
>
  <!-- Header -->
  <div class="bg-gradient-to-r from-emerald-500 to-teal-600 px-6 py-4 text-white">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <lucide-icon name="headphones" [size]="24"></lucide-icon>
        <div>
          <h3 class="font-semibold">Support MyAmana</h3>
          <p class="text-xs text-emerald-100">Comment pouvons-nous vous aider ?</p>
        </div>
      </div>
      <button (click)="closeWidget()" class="rounded-full p-1 hover:bg-white/20">
        <lucide-icon name="x" [size]="20"></lucide-icon>
      </button>
    </div>
  </div>

  <!-- Contenu -->
  <div class="max-h-[70vh] overflow-y-auto p-6">
    
    <!-- État: Succès -->
    <div *ngIf="isSuccess" class="text-center py-8">
      <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-emerald-100">
        <lucide-icon name="check" [size]="32" class="text-emerald-600"></lucide-icon>
      </div>
      <h4 class="text-lg font-semibold text-gray-900 mb-2">Ticket envoyé !</h4>
      <p class="text-sm text-gray-600 mb-6">
        Nous avons bien reçu votre demande et reviendrons vers vous rapidement par email.
      </p>
      <button 
        (click)="newTicket()"
        class="rounded-lg bg-emerald-500 px-6 py-2 text-sm font-medium text-white hover:bg-emerald-600"
      >
        Nouvelle demande
      </button>
    </div>

    <!-- État: Sélection catégorie -->
    <div *ngIf="!isSuccess && !form.category">
      <p class="mb-4 text-sm text-gray-600">Choisissez le type de votre demande :</p>
      
      <div class="space-y-3">
        <button
          *ngFor="let cat of categories"
          (click)="selectCategory(cat.id)"
          class="flex w-full items-center gap-4 rounded-xl border border-gray-200 p-4 text-left transition-all hover:border-emerald-300 hover:bg-emerald-50"
        >
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-gray-100" [ngClass]="cat.color">
            <lucide-icon [name]="cat.icon" [size]="20"></lucide-icon>
          </div>
          <div>
            <p class="font-medium text-gray-900">{{ cat.label }}</p>
            <p class="text-xs text-gray-500">{{ cat.description }}</p>
          </div>
          <lucide-icon name="chevron-right" [size]="20" class="ml-auto text-gray-400"></lucide-icon>
        </button>
      </div>
    </div>

    <!-- État: Formulaire -->
    <div *ngIf="!isSuccess && form.category">
      <!-- Bouton retour + catégorie sélectionnée -->
      <div class="mb-4 flex items-center gap-2">
        <button 
          (click)="goBack()" 
          class="flex h-8 w-8 items-center justify-center rounded-full hover:bg-gray-100"
        >
          <lucide-icon name="arrow-left" [size]="18" class="text-gray-600"></lucide-icon>
        </button>
        <span class="text-sm font-medium text-gray-700">{{ getCategoryLabel() }}</span>
      </div>

      <!-- Alerte pour les bugs -->
      <div *ngIf="form.category === 'bug'" class="mb-4 rounded-lg bg-amber-50 border border-amber-200 p-3">
        <div class="flex gap-2">
          <lucide-icon name="camera" [size]="18" class="text-amber-600 flex-shrink-0 mt-0.5"></lucide-icon>
          <p class="text-xs text-amber-800">
            <strong>Conseil :</strong> Pour nous aider à résoudre votre problème rapidement, 
            pensez à joindre une capture d'écran du bug.
          </p>
        </div>
      </div>

      <!-- Message -->
      <div class="mb-4">
        <label class="mb-1.5 block text-sm font-medium text-gray-700">Votre message</label>
        <textarea
          [(ngModel)]="form.message"
          rows="4"
          class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
          placeholder="Décrivez votre demande en détail..."
        ></textarea>
        <p class="mt-1 text-xs text-gray-500">Minimum 10 caractères</p>
      </div>

      <!-- Email -->
      <div class="mb-4">
        <label class="mb-1.5 block text-sm font-medium text-gray-700">Email de contact</label>
        <input
          type="email"
          [(ngModel)]="form.email"
          class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
          placeholder="votre@email.com"
        />
      </div>

      <!-- Pièce jointe -->
      <div class="mb-4">
        <label class="mb-1.5 block text-sm font-medium text-gray-700">
          Pièce jointe <span class="text-gray-400">(optionnel)</span>
        </label>
        
        <div *ngIf="!attachmentName" class="relative">
          <input
            type="file"
            (change)="onFileSelected($event)"
            accept="image/*,.pdf,.doc,.docx"
            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
          />
          <div class="flex items-center justify-center gap-2 rounded-lg border-2 border-dashed border-gray-300 px-4 py-3 hover:border-emerald-400 hover:bg-emerald-50">
            <lucide-icon name="upload" [size]="18" class="text-gray-400"></lucide-icon>
            <span class="text-sm text-gray-600">Cliquez pour ajouter un fichier</span>
          </div>
        </div>

        <div *ngIf="attachmentName" class="flex items-center justify-between rounded-lg bg-gray-100 px-3 py-2">
          <div class="flex items-center gap-2">
            <lucide-icon name="paperclip" [size]="16" class="text-gray-500"></lucide-icon>
            <span class="text-sm text-gray-700 truncate max-w-[200px]">{{ attachmentName }}</span>
          </div>
          <button (click)="removeAttachment()" class="text-gray-400 hover:text-red-500">
            <lucide-icon name="x" [size]="16"></lucide-icon>
          </button>
        </div>

        <p class="mt-1 text-xs text-gray-500">Images, PDF, Word - Max 5 Mo</p>
      </div>

      <!-- Erreur -->
      <div *ngIf="errorMessage" class="mb-4 rounded-lg bg-red-50 border border-red-200 p-3">
        <p class="text-sm text-red-700">{{ errorMessage }}</p>
      </div>

      <!-- Bouton submit -->
      <button
        (click)="submitTicket()"
        [disabled]="!isFormValid() || isSubmitting"
        class="flex w-full items-center justify-center gap-2 rounded-lg bg-gradient-to-r from-emerald-500 to-teal-600 px-4 py-3 text-sm font-medium text-white transition-all hover:from-emerald-600 hover:to-teal-700 disabled:cursor-not-allowed disabled:opacity-50"
      >
        <div *ngIf="isSubmitting" class="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"></div>
        <span *ngIf="!isSubmitting">Envoyer ma demande</span>
        <span *ngIf="isSubmitting">Envoi en cours...</span>
      </button>
    </div>
  </div>
</div>

