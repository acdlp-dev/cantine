@if(!isMailSent) {
<form class="my-10 space-y-6" [formGroup]="form" (ngSubmit)="onSubmit()">
  <div class="text-center">
    <h2 class="mb-1 text-3xl font-semibold text-foreground">Espace associations<span
        class="text-primary">!</span></h2>
    <p class="text-sm text-muted-foreground">{{ step === 1 ? 'Étape 1/2 : Informations personnelles' : 'Étape 2/2 :
      Informations de l\'association' }}</p>
  </div>

  <div class="space-y-3 text-left">
    <!-- ÉTAPE 1 : Informations personnelles -->
    @if(step === 1) {
    <!-- Champ Prénom -->
    <div class="relative">
      <input type="text" id="first-name" formControlName="firstName" class="peer block" placeholder=" " />
      <label for="first-name"
        class="absolute top-2 left-1 z-10 origin-[0] -translate-y-4 scale-95 transform bg-background px-2 text-sm text-muted-foreground duration-300 peer-placeholder-shown:top-1/2 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:scale-100 peer-focus:top-2 peer-focus:-translate-y-4 peer-focus:scale-95 peer-focus:px-2 peer-focus:text-primary">
        Prénom
      </label>
    </div>

    <!-- Champ Nom -->
    <div class="relative">
      <input type="text" id="last-name" formControlName="lastName" class="peer block" placeholder=" " />
      <label for="last-name"
        class="absolute top-2 left-1 z-10 origin-[0] -translate-y-4 scale-95 transform bg-background px-2 text-sm text-muted-foreground duration-300 peer-placeholder-shown:top-1/2 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:scale-100 peer-focus:top-2 peer-focus:-translate-y-4 peer-focus:scale-95 peer-focus:px-2 peer-focus:text-primary">
        Nom
      </label>
    </div>

    <!-- Champ Email -->
    <div class="relative">
      <input type="text" id="email" formControlName="email" class="peer block" placeholder=" " />
      <label for="email"
        class="absolute top-2 left-1 z-10 origin-[0] -translate-y-4 scale-95 transform bg-background px-2 text-sm text-muted-foreground duration-300 peer-placeholder-shown:top-1/2 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:scale-100 peer-focus:top-2 peer-focus:-translate-y-4 peer-focus:scale-95 peer-focus:px-2 peer-focus:text-primary">
        Adresse email
      </label>
    </div>

    <!-- Message d'erreur pour le champ email -->
    <div *ngIf="submitted && form.get('email')?.invalid">
      <div *ngIf="form.get('email')?.hasError('required')" class="text-xs text-red-500">
        L'email est requis.
      </div>
      <div *ngIf="form.get('email')?.hasError('pattern')" class="text-xs text-red-500">
        L'email doit avoir un format valide avec une extension (exemple : &#64;domaine.com).
      </div>
    </div>

    <!-- Champ Mot de passe -->
    <div class="relative">
      <input [type]="passwordTextType ? 'text' : 'password'" id="password" formControlName="password" class="peer block"
        placeholder=" " />
      <label for="password"
        class="absolute top-2 left-1 z-10 origin-[0] -translate-y-4 scale-95 transform bg-background px-2 text-sm text-muted-foreground duration-300 peer-placeholder-shown:top-1/2 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:scale-100 peer-focus:top-2 peer-focus:-translate-y-4 peer-focus:scale-95 peer-focus:px-2 peer-focus:text-primary">
        Mot de passe
      </label>
      <span class="absolute top-2.5 right-5 cursor-pointer text-muted-foreground" (click)="togglePasswordTextType()">
        <svg-icon [src]="
          passwordTextType
            ? 'assets/icons/heroicons/outline/eye.svg'
            : 'assets/icons/heroicons/outline/eye-off.svg'
        " [svgClass]="'h-5 w-5'">
        </svg-icon>
      </span>
    </div>

    <!-- Barres de force -->
    <div class="grid grid-cols-4 gap-2">
      <div *ngFor="let i of [1, 2, 3, 4]; let index = index" class="h-1 rounded-sm" [ngClass]="{
              'bg-primary': passwordStrength > index,
              'bg-muted': passwordStrength <= index
            }">
      </div>
    </div>
    <ul class="text-xs text-muted-foreground mt-1">
      <li [ngClass]="{ 'text-primary': passwordStrength >= 1 }">Au moins 8 caractères</li>
      <li [ngClass]="{ 'text-primary': passwordStrength >= 2 }">Au moins une lettre</li>
      <li [ngClass]="{ 'text-primary': passwordStrength >= 3 }">Au moins un chiffre</li>
      <li [ngClass]="{ 'text-primary': passwordStrength >= 4 }">Au moins un symbole (&#64;, $, !, %, etc.)</li>
    </ul>

    <!-- Champ Confirmation du mot de passe -->
    <div class="relative">
      <input type="password" id="confirm-password" formControlName="confirmPassword" class="peer block"
        placeholder=" " />
      <label for="confirm-password"
        class="absolute top-2 left-1 z-10 origin-[0] -translate-y-4 scale-95 transform bg-background px-2 text-sm text-muted-foreground duration-300 peer-placeholder-shown:top-1/2 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:scale-100 peer-focus:top-2 peer-focus:-translate-y-4 peer-focus:scale-95 peer-focus:px-2 peer-focus:text-primary">
        Confirmation du mot de passe
      </label>
    </div>
    <div *ngIf="form.errors?.['mismatch'] && (submitted || form.get('confirmPassword')?.touched)"
      class="text-xs text-red-500">
      Les mots de passe ne correspondent pas.
    </div>
    }

    <!-- ÉTAPE 2 : Informations de l'association -->
    @if(step === 2) {
    <!-- Champ SIREN avec validation en temps réel -->
    <div class="relative">
      <input type="text" id="siren-step2" formControlName="siren" class="peer block" placeholder=" " maxlength="9"
        (input)="formatSirenInput($event)" (blur)="validateSiren()" />
      <label for="siren-step2"
        class="absolute top-2 left-1 z-10 origin-[0] -translate-y-4 scale-95 transform bg-background px-2 text-sm text-muted-foreground duration-300 peer-placeholder-shown:top-1/2 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:scale-100 peer-focus:top-2 peer-focus:-translate-y-4 peer-focus:scale-95 peer-focus:px-2 peer-focus:text-primary">
        Numéro SIREN (9 chiffres)
      </label>
      <!-- Indicateur de chargement -->
      <span *ngIf="isLoadingRaisonSociale" class="absolute top-2.5 right-5 text-muted-foreground">
        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
          </path>
        </svg>
      </span>
    </div>

    <!-- Message d'erreur pour le champ SIREN -->
    <div *ngIf="(submitted || form.get('siren')?.touched) && form.get('siren')?.invalid" class="text-xs text-red-500">
      <div *ngIf="form.get('siren')?.hasError('required')">
        Le numéro SIREN est requis.
      </div>
      <div *ngIf="form.get('siren')?.hasError('pattern') || form.get('siren')?.hasError('invalidSiren')">
        Le numéro SIREN doit contenir exactement 9 chiffres.
      </div>
    </div>

    <!-- Message d'erreur API SIREN -->
    <div *ngIf="sirenError" class="text-xs text-orange-500">
      {{ sirenError }}
    </div>

    <!-- Affichage de la raison sociale récupérée -->
    <div *ngIf="raisonSociale" class="relative">
      <input type="text" id="raison-sociale" [value]="raisonSociale"
        class="peer block bg-green-50 border-green-300 text-green-800 cursor-not-allowed" placeholder=" " disabled />
      <label for="raison-sociale"
        class="absolute top-2 left-1 z-10 origin-[0] -translate-y-4 scale-95 transform bg-green-50 px-2 text-sm text-green-600">
        Raison sociale
      </label>
    </div>

    <!-- Upload du document justificatif -->
    <div class="space-y-2">
      <label class="block text-sm font-medium text-foreground">
        Document justificatif <span class="text-red-500">*</span>
        <span class="text-xs text-muted-foreground font-normal">(Statuts association loi 1901, récépissé de
          déclaration)</span>
      </label>

      <!-- Drop zone -->
      <div class="rounded-md border-2 border-dashed p-5 text-center transition-colors" [ngClass]="{
          'border-muted hover:border-primary/60 hover:bg-muted': !isDragging,
          'border-primary bg-primary/5': isDragging
        }" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event)"
        (click)="fileInput.click()" role="button" tabindex="0" (keydown.enter)="fileInput.click()"
        (keydown.space)="fileInput.click()" aria-label="Déposer un fichier ou cliquer pour sélectionner">
        <div class="flex flex-col items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-muted-foreground" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
          </svg>
          <div class="text-sm">
            <span class="font-medium text-foreground">Glissez-déposez</span>
            <span class="text-muted-foreground"> votre document ici ou </span>
            <span class="text-primary underline">cliquez pour choisir</span>
          </div>
          <div class="text-xs text-muted-foreground">PDF, JPG, PNG • 10 MB max • 1 fichier</div>
          <div *ngIf="selectedFile"
            class="mt-2 inline-flex items-center gap-2 rounded-md bg-muted px-2 py-1 text-xs text-foreground">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-primary" viewBox="0 0 20 20"
              fill="currentColor">
              <path fill-rule="evenodd"
                d="M16.707 5.293a1 1 0 010 1.414l-7.5 7.5a3 3 0 11-4.243-4.243l6-6a2 2 0 112.828 2.828L7.828 11.257a1 1 0 11-1.414-1.414l6-6a.5.5 0 10-.707-.707l-6 6a2 2 0 102.828 2.828l7.5-7.5a1 1 0 011.414 0z"
                clip-rule="evenodd" />
            </svg>
            <span>{{ selectedFile.name }}</span>
            <button type="button" class="text-muted-foreground hover:text-foreground"
              (click)="$event.stopPropagation(); removeSelectedFile()">Retirer</button>
          </div>
        </div>
        <input #fileInput type="file" id="document-upload" accept=".pdf,.jpg,.jpeg,.png"
          (change)="onFileSelected($event)" class="hidden" />
      </div>

      <!-- Message d'erreur -->
      <div *ngIf="documentError" class="text-xs text-red-500">
        {{ documentError }}
      </div>
    </div>
    }
  </div>

  <!-- Termes et conditions (uniquement étape 2) -->
  @if(step === 2) {
  <div class="space-y-2">
    <div class="flex items-center gap-1">
      <input id="accept-term" name="accept-term" formControlName="acceptTerm" type="checkbox" />
      <label for="accept-term" class="ml-2 block text-sm text-muted-foreground">
        J'accepte les
      </label>
      <a href="https://home.myamana.fr/cgu" target="_blank" rel="noopener noreferrer"
        class="text-primary font-semibold">
        conditions générales d'utilisation
      </a>
    </div>
    <div *ngIf="submitted && form.get('acceptTerm')?.invalid" class="text-xs text-red-500">
      Vous devez accepter les termes pour continuer.
    </div>
  </div>
  }

  <!-- Boutons de navigation -->
  <div class="flex gap-3">
    @if(step === 2) {
    <app-button full impact="light" tone="light" shape="rounded" size="medium" type="button"
      (click)="previousStep()">Précédent</app-button>
    }
    @if(step === 1) {
    <app-button full impact="bold" tone="primary" shape="rounded" size="medium" type="button"
      (click)="nextStep()">Suivant</app-button>
    }
    @if(step === 2) {
    <button type="submit" class="w-full rounded-lg bg-primary text-primary-foreground px-5 py-2 text-sm font-semibold hover:bg-primary/90">Inscription</button>
    }
  </div>

  <!-- Déjà un compte -->
  <div class="flex items-center text-sm text-muted-foreground">
    Déjà un compte ?
    <app-button routerLink="/backoffice-auth/sign-in" impact="none" tone="primary" shape="rounded" size="small">
      Connectez-vous
    </app-button>
  </div>
</form>
} @else {
<app-confirmation
  [message]="'Un mail vous a été envoyé pour activer votre compte. Si vous ne le trouvez pas, vérifiez dans vos spams :)'"></app-confirmation>
}