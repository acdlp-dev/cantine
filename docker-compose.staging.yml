version: "3.9"

services:

  #########################################
  # MYSQL
  #########################################
  mysql:
    image: mysql:8.0
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${LOCAL_DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${LOCAL_DB_NAME}
      MYSQL_USER: ${LOCAL_DB_USER}
      MYSQL_PASSWORD: ${LOCAL_DB_PASSWORD}
    volumes:
      - dbdata:/var/lib/mysql
      - "./mysql/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro"
    ports:
      - "3306:3306"
    restart: unless-stopped
    networks:
      - app-network
    command: --sql-mode=""

  #########################################
  # NGINX
  #########################################
  nginx:
    image: nginx:stable-alpine
    container_name: nginx
    volumes:
      # Angular compiled files
      - angular-dist:/var/www/client/angular/dist/browser:ro
      
      # ðŸš¨ IMPORTANT : le script Ã©crase ./nginx/current.conf
      - "./nginx/current.conf:/etc/nginx/conf.d/default.conf:ro"

      # Maintenance page
      - "./nginx/maintenance:/var/www/maintenance:ro"

      # Static assets (images etc.)
      - "./src/www/acdlp/client/acdlp-angular/src/assets:/var/www/assets:ro"

      # Certbot volumes (persist)
      - "./certbot/conf:/etc/letsencrypt"
      - "./certbot/www:/var/www/certbot"

    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - angular
    networks:
      - app-network

  #########################################
  # CERTBOT (Renewal Only)
  #########################################
  certbot:
    image: certbot/certbot
    container_name: certbot
    entrypoint: >
      /bin/sh -c 'trap exit TERM; 
      while :; do
        certbot renew --webroot -w /var/www/certbot;
        sleep 12h & wait $${!};
      done;'
    volumes:
      - "./certbot/conf:/etc/letsencrypt"
      - "./certbot/www:/var/www/certbot"
      - "./certbot/entrypoint.sh:/entrypoint.sh:ro"
    networks:
      - app-network
    depends_on:
      - nginx

  #########################################
  # NODE API
  #########################################
  node:
    image: node:20
    container_name: node
    working_dir: /usr/src/app
    volumes:
      - "./src/www/acdlp/server/node:/usr/src/app"
      - "./.env:/usr/src/app/.env:ro"
      - "./src/www/acdlp/server/node/pdf/recuFiscal:/usr/src/app/pdf/recuFiscal"
      - "./src/www/acdlp/client/acdlp-angular/src/assets:/usr/src/app/assets"
      - "logs-data:/var/log/acdlp"
    ports:
      - "4242:4242"
    command: >
      bash -c "npm install -g npm@10.9.1 &&
      npm install &&
      npm start"
    depends_on:
      - mysql
    networks:
      - app-network
    stdin_open: true
    tty: true

  #########################################
  # ANGULAR (Build Only)
  #########################################
  angular:
    image: node:20
    container_name: angular
    working_dir: /usr/src/app/src/www/acdlp/client/acdlp-angular
    environment:
      NG_CLI_ANALYTICS: "false"
    volumes:
      - ./src/www/acdlp/client/acdlp-angular:/usr/src/app/src/www/acdlp/client/acdlp-angular
      - angular-dist:/usr/src/app/src/www/acdlp/client/acdlp-angular/dist/angular-tailwind/browser
    command: >
      bash -c "
      echo 'Starting npm install...' &&
      npm install -g npm@latest &&
      echo 'Starting Angular CLI installation...' &&
      npm install -g @angular/cli@latest &&
      echo 'Installing dependencies...' &&
      npm install --legacy-peer-deps &&
      echo 'Building Angular project for staging...' &&
      npm run staging -- --base-href=/app/"
    depends_on:
      - mysql
    networks:
      - app-network
    stdin_open: true
    tty: true

  #########################################
  # PHPMYADMIN
  #########################################
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: phpmyadmin
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      UPLOAD_LIMIT: 10000000000
    ports:
      - "8080:80"
    depends_on:
      - mysql
    restart: unless-stopped
    networks:
      - app-network

  #########################################
  # LOKI
  #########################################
  loki:
    image: grafana/loki:2.9.0
    container_name: loki
    ports:
      - "3100:3100"
    volumes:
      - "./loki/config.yml:/etc/loki/config.yml"
      - "loki-data:/loki"
    command: -config.file=/etc/loki/config.yml
    restart: unless-stopped
    networks:
      - app-network

  #########################################
  # PROMTAIL
  #########################################
  promtail:
    image: grafana/promtail:2.9.0
    container_name: promtail
    volumes:
      - "./promtail/config.yml:/etc/promtail/config.yml"
      - "logs-data:/var/log/acdlp:ro"
    command: -config.file=/etc/promtail/config.yml
    restart: unless-stopped
    depends_on:
      - loki
    networks:
      - app-network

  #########################################
  # GRAFANA
  #########################################
  grafana:
    image: grafana/grafana:10.2.0
    container_name: grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SERVER_ROOT_URL=https://dev.acdlp.com/grafana
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_USERS_AUTO_ASSIGN_ORG_ROLE=Admin
      - GF_AUTH_GITHUB_ENABLED=true
      - GF_AUTH_GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GF_AUTH_GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      - GF_AUTH_GITHUB_ALLOW_SIGN_UP=true
      - GF_AUTH_GITHUB_AUTO_LOGIN=false
      - GF_AUTH_DISABLE_LOGIN_FORM=true
    volumes:
      - "grafana-data:/var/lib/grafana"
      - "./grafana/provisioning:/etc/grafana/provisioning"
    restart: unless-stopped
    depends_on:
      - loki
    networks:
      - app-network

#########################################
# NETWORK & VOLUMES
#########################################

networks:
  app-network:
    driver: bridge

volumes:
  dbdata:
  angular-dist:
  logs-data:
  loki-data:
  grafana-data:
